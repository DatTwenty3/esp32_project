#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <driver/gpio.h>
#include "led_7_segs.h"
#include "esp_timer.h"
#include "esp_log.h"
#include "esp_sleep.h"
#include "sdkconfig.h"

#define EnLed1	5
#define EnLed2	18
#define HornH	21
#define HornL	22
#define B_Up	39
#define B_Down	36
#define B_Horn	34
#define ON		1
#define OFF		0
#define TotalNote   150


static void periodic_timer_1ms_callback(void* arg);

static const char* TAG = "esp32";
esp_timer_handle_t periodic_timer_1ms;
unsigned int Cnt1,Cnt2,CntLed,CntNoteH,CntNoteL,NumNoteH,NumNoteL;
unsigned char Debound_Up,Debound_Down;
unsigned int LED=1,LED1,LED2;
unsigned char FlagUp,FlagFirst;
unsigned char TableLed[]={0x30,0xF3,0xA4,0xA1,0x63,0x29,0x28,0xB3,0x20,0x21,0xFF};
unsigned int TableTimeH[12][150]=
{
//bai 1
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{402, 38,395, 35,154, 43, 29, 52, 83, 31,414, 40,387, 36,355, 32,170, 35, 45, 41, 82, 27,388, 31,170, 34, 54, 35, 70, 29,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
163, 32, 62, 38, 68, 29,176, 32, 60, 40, 61, 26,373, 31,171, 35, 47, 46, 76, 29,181, 35,165, 37,154, 42,170,359, 41, 38,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
158, 39,158, 63,105,160, 28, 43,161, 44,148,315, 65, 35,172, 33,199,178, 31, 40, 28, 52, 69,122, 69, 42,131,109, 85,194,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
182,135,213,138, 46, 45, 37, 45, 56,105,215,144, 45, 44, 35, 58, 58,112,226,143, 41, 42, 41, 55, 48,119, 71, 43, 31, 52,
//61      62      63      64      65      66      67      68      69      70     71       72     73       74      75
46,139, 58, 38,157, 44,296,171, 25, 37,168, 37,367, 35,369, 35,370, 34,180, 37,371, 36,170, 36,152, 39,164, 39,363, 35},

//bai 2
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{ 123, 39,159, 40, 43, 39, 64,323, 64, 35,137, 38, 44, 39, 64,134, 40, 36, 39, 36, 64,115, 60, 35,138,306, 35, 37,132, 38,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 140, 89, 93,152, 21, 40,132, 40,148,291, 42, 42,114, 42,129,116,218,120,204,280, 38, 48,137,323, 47, 45,120,153, 30, 44,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 126,155, 19, 42,121, 45,119,132, 24, 43,135, 44,123,137, 01, 01, 15, 41, 26, 47, 60,124, 38, 44,116, 93,108,283, 43,112,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
 59,127, 42, 45, 26, 44, 49,136, 56, 45, 82,134, 52, 41,130, 42,15, 41, 26, 47, 60,124, 38, 44,116, 93,108,283, 43,112,
//61      62      63      64      65
148, 38,317, 36,154, 33,322, 38,144, 35},

//bai 3
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{ 181, 29,145,157, 30, 24, 46, 42, 76,135, 75, 19,169,332, 56, 21,163, 27,143, 69,108,167, 23, 26,165, 26,154,305, 42, 25,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
175, 25,150,134,220,108,258,292, 46, 30,173,314, 55, 26,146,158, 39, 26,146,172, 13, 24, 13, 03,153, 29,136,140, 35, 25,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
180, 23, 90, 02, 74,153, 20, 24, 02, 02, 03, 03, 2, 1, 26, 57, 67,158, 45, 27,339,170, 21, 22, 16, 01,156, 24,366, 21,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
352, 21,372, 19,175, 18,394, 18,163, 20,166, 22,181, 20, 11, 02,341, 19,172, 20,351, 15, 1, 04,171, 18, 2, 1, 8, 2,
//61      62      63      64      65
162, 19,185, 20,370, 22,366, 20,170, 17},

//bai 4
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{318,164, 52, 33,375, 29,160,156, 34, 28,172, 30,318,168, 21, 33,294, 32,157,143, 8, 31,181, 32,360, 31,357, 33,342, 38,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 166, 40, 49, 43, 48, 27,396, 36,150, 36, 45, 42, 62, 29,386, 34,144, 37, 32, 47, 67, 27,161, 34, 52, 33, 60, 26,158, 33,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 49, 33, 63, 29,353, 33,159, 33, 42, 36, 84, 25,176, 30,168, 34,379, 37,345, 34,146, 34, 44, 35, 68, 27,165, 32,159, 30,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
117, 36, 37, 41, 62, 29,154, 35,167,108,253,112,252,116,222,130, 40, 42,146, 89,239,123, 55, 37,133, 71, 93,123, 55, 38,
//61      62      63      64      65
121, 70,128,106,244,113, 44, 40, 40, 44},

//bai 5
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{ 70, 30,148, 37, 18, 48, 66,121, 49, 29, 29, 35, 61,101, 73, 37,141,268, 65, 32,119, 45,132, 62, 97,156, 35, 30, 12, 02,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
130, 34,154,263, 84, 29,113, 33,151,124,218,109,227,108,201,132, 44, 30,145, 88,210,119, 40, 33,133, 94, 96, 30,123, 84,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
109, 67,222,101,249,153, 44,126, 29, 99,226,134, 42,134, 11, 1, 21,107, 86, 29, 38, 50, 47,125, 65, 28, 11, 1, 8, 4,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
21, 34, 64,126, 48, 32, 00, 62, 72,115, 53, 35,127,171, 25, 28,159, 33,363, 26,325, 24,346, 21,163, 27,353, 18,163, 23,
//61      62      63      64      65
148, 38,317, 36,154, 33,322, 33,144, 35},

//bai 6
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{173, 36,132, 43,153,160, 38, 34,157, 34,134, 36,144,146, 34, 31,160, 31,159, 31,165,152, 24, 29, 46, 40, 48, 84, 92, 30,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
147,278, 62, 31,143, 34,148, 93, 97,144, 35, 32,147, 34,155,209,122, 32,144, 37,198, 32,347, 28,348, 31,335, 33,146, 33,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 327, 33,144, 35,138, 33,157, 31,359, 31,159, 31,334, 30,146, 31,153, 31,162, 30,159, 36,164, 34,157, 26,137, 31, 41, 46,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
 50, 25,165, 37, 46, 45, 50, 26,154, 38, 35, 40, 55, 26,333, 33,148, 35, 46, 42, 47, 29,144, 35, 49, 43, 46, 30,134, 38,
//61      62      63      64      65
154, 37,162,275, 94, 38,115, 49,113,117},

//bai 7
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{57, 47,286,318, 43, 40,138,133, 68, 34,132,163, 48, 32,156, 33,149,148, 42, 32,153, 35,144,129, 33, 36, 35, 45, 55,105,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 82, 33,138,300, 35, 32,140, 35,145,121,221,105,256,304, 40, 39,122, 37,132, 83, 85,144, 52, 33,136, 34,140,258, 66, 32,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 137, 36,138, 97,238,110,232,219,119, 35,116, 42,169, 35,294,324, 52, 35,316,302, 60, 34,106,140, 133, 42, 33,124,38,123,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
46, 97,134, 27,157,136, 52, 29, 40, 37, 44,105, 68, 34,122,137, 41, 32,145, 35,142,243, 77, 30,124,136, 47, 34,132,140,
//61      62      63      64      65
148, 38,317, 36,154, 33,322, 33,144, 35},

//bai 8
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{371, 35,344, 21, 78, 32, 54, 27, 90, 34, 27, 25,412, 34,368, 37,329, 26, 65, 31, 69, 26, 90, 31, 66, 23,361, 31,172, 31,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
54, 36, 57, 31,361, 29,169, 31, 51, 37, 67, 24,389, 30,159, 31, 50, 35, 72, 27,163, 32, 47, 41, 73, 29,147, 31, 49, 35,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 64, 28,343, 28,169, 31, 47, 36, 83, 30,162, 29,185, 29,164, 28, 41, 41, 77, 28,140, 36,157,135, 55, 42, 12, 53, 78, 30,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
141, 37,169,131,248,118,271,317, 48, 40,155, 47, 20, 48, 66,271,114, 35,156, 37, 36, 44, 66,120, 52, 38, 29, 40, 68,113,
//61      62      63      64      65
75, 38,137, 93,121,301, 68, 37,151, 37},

//bai 9
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{121, 30, 89, 39,279, 33,278,256, 21, 36,207,185, 53, 40,190,276, 53, 31,107, 31, 80, 34,242, 29,198,225, 50, 31,198,193,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
38, 31,194,129,224,155, 28, 36,165,139,245,145, 54, 38,145,129,246,144, 31, 41,145, 86, 88,142, 44, 35,142, 75,141,117,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
  01, 01,215,151, 40, 33, 44, 42, 65,117,248,132, 48, 30, 51, 40, 63,118,230,140, 51, 30, 49, 41, 52,123, 51, 35, 33, 45,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
61,129, 49, 33, 39, 43, 65,195,170,161, 25, 31, 41, 47, 62,112,244,146, 28, 33, 41, 51, 51,123, 75, 34,146,135, 42, 31,
//61      62      63      64      65
144,121, 57, 32,149, 35,152,305, 77, 32},

//bai 10
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{595, 43,157,174, 37, 39, 37, 45, 76,134, 54, 42,197,354, 49, 36,159, 35,175, 69,107,177, 41, 40,145, 43,165,332, 48, 40,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
25,172, 23, 55, 37, 72, 27,172, 26, 64, 37, 53, 28,150, 32, 46, 44, 59, 23,357, 30,162, 30, 48, 41, 70, 26,174, 31,170,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 32,421, 35,349, 32,155, 33, 45, 40, 56, 26,174, 33,149, 26,156, 35, 46, 37, 75, 26,147, 35,150, 36,134, 35, 42, 38, 59,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
46, 97,134, 27,157,136, 52, 29, 40, 37, 44,105, 68, 34,122,137, 41, 32,145, 35,142,243, 77, 30,124,136, 47, 34,132,140,
//61      62      63      64      65
148, 38,317, 36,154, 33,322, 33,144, 35},

//bai 11
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{360,183, 45, 29, 01, 03,391, 28, 02, 03,178,174, 33, 28,179, 31,366,172, 48, 29,385, 30,185,184, 10, 33,187, 31,184, 25,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 37, 40,103, 33,203, 38,189,364, 76, 34,169, 43, 24, 50, 72,298,113, 30,162, 29, 1, 8, 1, 2, 29, 46, 60,125, 63, 25,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
  63, 25, 10, 3, 35, 3, 1, 30, 72,121, 67, 39, 25, 48, 2, 1, 76,247, 3, 1, 2, 1,150, 28,156, 38, 27, 50, 75,134,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
46, 97,134, 27,157,136, 52, 29, 40, 37, 44,105, 68, 34,122,137, 41, 32,145, 35,142,243, 77, 30,124,136, 47, 34,132,140,
//61      62      63      64      65
148, 38,317, 36,154, 33,322, 33,144, 35},

//bai 12
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{13, 72, 13, 51,170, 34,142, 38,134, 41,155,163,351, 39, 31, 47, 60, 30,167, 31,158, 33,142, 40,154,202,302, 28, 48, 41,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 68, 29,168, 26,167, 29,132, 37,178,328, 43, 37,145, 40,148, 79, 84,153, 35, 36,150, 37,158,308, 60, 38,155, 35,140,127,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
232,142,238,135,217,160, 33, 35, 33, 45, 84,122,228,128, 39, 27, 48, 42, 83,114,234,133, 35, 33, 43, 41, 74,141, 46, 31,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
 38, 43, 89,150, 34, 31,163,152, 25, 35,156, 38,127, 44,165,307, 50, 39,148, 38,149, 91, 89,163, 25, 38,145, 93,105,277,
//61      62      63      64      65       66      67       68     69       70     71      72      73     75        75
134,143, 51, 43, 19, 61, 55,115,216,136, 35, 43, 35, 54, 48,124,205,141, 31, 35, 36, 44, 58,127, 53, 39, 24, 55, 54,133},
};

unsigned int TableTimeL[12][150]=
{
//bai 1
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{ 53,141, 55,141,252,137, 53,141, 55,141,253,137, 52,141, 55,141,253,137, 53,140, 56,141,252,137, 53,141, 55,141,253,136,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 53,141, 55,141,253,137, 52,141, 56,141,252,137, 53,141, 55,141,253,137, 52,141, 55,141,253,137, 53,141, 55,141,252,137,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 200,200,200,200,200,200,200,200,200,200,250,250,250,250,250,250,250,250,250,250,050,050,050,050,050,050,050,050,050,050,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
 31, 35,136, 39,130,140, 29, 36,144, 39,121,135, 26, 34, 33, 45, 63,108, 63, 38,118,106, 98,168,177,228, 77, 38, 24, 48,
//61      62      63      64      65
 250,250,050,050,050,050,050,050,050,050},
//bai 2
//1       2       3       4       5       6       7       8       9      10      11      12      13      14      15
{123, 39,159, 40, 43, 39, 64,323, 64, 35,137, 38, 44, 39, 64,134, 40, 36, 39, 36, 64,115, 60, 35,138,306, 35, 37,132, 38,
//16     17      18      19      20      21      22      23      24      25      26      27      28      29      30
 140, 89, 93,152, 21, 40,132, 40,148,291, 42, 42,114, 42,129,116,218,120,204,280, 38, 48,137,323, 47, 45,120,153, 30, 44,
//31    32       33      34      35      36      37      38      39      40      41      42      43      44      45
 126,155, 19, 42,121, 45,119,132, 24, 43,135, 44,123,137, 01, 01, 15, 41, 26, 47, 60,124, 38, 44,116, 93,108,283, 43,112,
 //46    47       48      49      50      51      52      53      54      55      56      57      58      59      60
 59,127, 42, 45, 26, 44, 49,136, 56, 45, 82,134, 52, 41,130, 42,320, 38,311, 38,304, 35,137, 39,315, 36,128, 41,150, 38,
//61      62      63      64      65
148, 38,317, 36,154, 33,322, 33,144, 35},
{0},
{0},
{0},
{0},
{0},
{0},
{0},
{0},
{0},
{0},
};


void app_main(void)
{
	//Config led 7 SEGS
	config_7segs();
	//Config for HornH, HornL port
	gpio_set_direction(HornH, GPIO_MODE_OUTPUT);
	gpio_set_direction(HornL, GPIO_MODE_OUTPUT);
	//Config for EnLed1, EnLed2 port
	gpio_set_direction(EnLed1, GPIO_MODE_OUTPUT);
	gpio_set_direction(EnLed2, GPIO_MODE_OUTPUT);
	//Config for 1ms timer
    const esp_timer_create_args_t periodic_1ms_timer_args = {
                .callback = &periodic_timer_1ms_callback,
                /* name is optional, but may help identify the timer when debugging */
                .name = "periodic_timer_1ms"
    };
	ESP_ERROR_CHECK(esp_timer_create(&periodic_1ms_timer_args, &periodic_timer_1ms));
	ESP_ERROR_CHECK(esp_timer_start_periodic(periodic_timer_1ms, 1000));
    ESP_ERROR_CHECK(esp_timer_stop(periodic_timer_1ms));
    ESP_ERROR_CHECK(esp_timer_delete(periodic_timer_1ms));
    ESP_LOGI(TAG, "Stopped and deleted timers");

}

static void periodic_timer_1ms_callback(void* arg)
{
	led_7_seg_application_1ms_elapsed();
	if(B_Up == 0)
	{
		Debound_Up ++;
		if(Debound_Up == 120)
		{
			LED ++;
			if(LED >= 12)LED = 12;
			//LED1 = LED/10;
			//LED2 = LED%10;
			Debound_Up = 0;
		}
	}
	if(B_Down == 0)
	{
		Debound_Down ++;
		if(Debound_Down == 120)
		{
			LED --;
			if(LED <= 1)LED = 1;
			//LED1 = LED/10;
			//LED2 = LED%10;
			Debound_Down = 0;
		}
	}
	else
	{
		Debound_Down = 0;
	}
	    Cnt1 ++;
	if(Cnt1 == 15)
	{
		CntLed ++;
		LED1 = LED/10;
		LED2 = LED%10;
	if(CntLed == 1)
	{
//		EnLed1 = 1;
//		EnLed2 = 0;
		gpio_set_level(EnLed1, 1);
		gpio_set_level(EnLed2, 0);
//		PORTD =  TableLed[LED1];
		led_7_seg_set_number(LED1);
	}
	if(CntLed == 2)
	{
//		EnLed1 = 0;
//		EnLed2 = 1;
		gpio_set_level(EnLed1, 1);
		gpio_set_level(EnLed2, 0);
//		PORTD =  TableLed[LED2];
		led_7_seg_set_number(LED2);
		CntLed = 0;
	}
	//Cnt2++;
	//PORTD =  TableLed[Cnt2];
	if(FlagUp)
	{



	}
	Cnt1 = 0;

	}
	if(B_Horn == 0)
	{
		if(FlagFirst == 0)FlagFirst = 1;
		if(FlagFirst == 1)
		{
			CntNoteH ++;
			CntNoteL ++;
			if(CntNoteH == TableTimeH[LED-1][NumNoteH])
			{

				  if((NumNoteH%2)==0)
				 {
//					 HornH = ON;
					 gpio_set_level(HornH, ON);
				 }
				 else if((NumNoteH%2) == 1)
				 {
//					 HornH = OFF;
					 gpio_set_level(HornH, OFF);
				 }

				 NumNoteH ++;
				 if(NumNoteH >= TotalNote)
				 {
					 FlagFirst = 0;
					 NumNoteH = TotalNote-1;
				 }
				 CntNoteH = 0;
			}
		}
	}
	else
	{
		NumNoteH = 0;
		CntNoteH = 0;
//		HornH = OFF;
//		HornL = OFF;
		gpio_set_level(HornH, OFF);
		gpio_set_level(HornL, OFF);
	}
}
